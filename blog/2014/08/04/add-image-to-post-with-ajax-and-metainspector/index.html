
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How I Added Images to My Postit App With AJAX and MetaInspector - Doug S.</title>
  <meta name="author" content="Doug Steinberg">

  
  <meta name="description" content="In Tealeaf Academy&rsquo;s second course Rapid Prototyping with Ruby on Rails we built an app called Postit. It&rsquo;s bassically a clone of the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://doug7410.github.io/blog/2014/08/04/add-image-to-post-with-ajax-and-metainspector">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Doug S." type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Doug S.</a></h1>
  
    <h2>web development with Ruby on Rails and more.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:doug7410.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <!--<li><a href="/portfolio">Portfolio</a></li>-->
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">How I Added Images to My Postit App With AJAX and MetaInspector</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-04T15:07:35+00:00" pubdate data-updated="true">Aug 4<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>In <a href="gotealeaf.com">Tealeaf Academy&rsquo;s</a> second course <a href="http://www.gotealeaf.com/curriculum#!rails">Rapid Prototyping with Ruby on Rails</a> we built an app called Postit. It&rsquo;s bassically a clone of the popular site Reddit.com. Of of the featues of this app is to add a URL to the site you are posting about. I decided to add a feature for grabbing an image on that URL. To do this I used some AJAX and a web scraping gem. Here is what the page looks like in action.</p>

<p><img src="/images/image_scrapper.jpg"></p>

<p>Here is the link to the actual working app <a href="http://shielded-retreat-9536.herokuapp.com/">http://shielded-retreat-9536.herokuapp.com/</a> <!--more--></p>

<p>You&rsquo;ll have to register and create a post in order to try out the image feature.</p>

<h2>Here the rundown on how I did it.</h2>

<h3>1. First add a column to the database for the image</h3>

<p>The first thing I had to do was add a <code>post_image</code> column to the <code>posts</code> table. I went into the console and created a migration.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rails generate migration add_post_image_to_posts</span></code></pre></td></tr></table></div></figure>


<p>This created the migration file. Below is the file with the code to add the new column.</p>

<figure class='code'><figcaption><span>20140711160221_add_post_image_to_posts.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddPostImageToPosts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">add_column</span> <span class="ss">:posts</span><span class="p">,</span> <span class="ss">:post_image</span><span class="p">,</span> <span class="ss">:string</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. the basic workflow for getting the images from a URL</h3>

<p>In this application a post has 5 attributes (not including timestamps). They are:</p>

<ul>
<li>title</li>
<li>url</li>
<li>description</li>
<li>slug</li>
<li>post_image</li>
<li>user_id</li>
</ul>


<p>I&rsquo;m using a web scraper called <a href="https://github.com/jaimeiniesta/metainspector">metainspector</a> to fetch an array of images from the <code>url</code> given to the post. To access the images returned by metainspector I have to take following steps:</p>

<ol>
<li>create a link that sends an HTTP request to a <code>post_image</code> action in the <code>post_controller</code></li>
<li>in that controller action is a method that uses the post <code>url</code></li>
<li>inside that method, <strong>metainspector</strong> uses the <code>url</code> to return an array of images that are on the url&rsquo;s web page</li>
<li>a list of images is shown to choose an image to the post</li>
</ol>


<p>That&rsquo;s the basic outline of the workflow for getting the images. Here is how I did it.</p>

<h3>3. The workflow in the UI</h3>

<p>I&rsquo;m using AJAX and a very slick JavaScript interface in the UI to select the image. The workflow in the UI works like this:</p>

<ol>
<li> when creating or editing a post, enter a url in the URL form field</li>
<li> click on the &ldquo;Choose Post Image&rdquo; button</li>
<li> under the input and button a hidden div slides down with all the images generated from the URL</li>
<li> the user clicks on an image to choose it and assign it to the post</li>
</ol>


<p>Rails has a very easy way to AJAXify a link by adding <code>remote: true</code> to a <code>link_to</code> helper method. Here is the section of the form with the URL field and the link:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;div class=&quot;control-group&quot;&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:url</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:url</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Choose Post Image&#39;</span><span class="p">,</span> <span class="n">post_image_path</span><span class="p">,</span> <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nb">method</span><span class="p">:</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-primary&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;choose_img_btn&#39;</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are two things about this link use some special rails magic</p>

<ul>
<li><code>remote" true</code></li>
<li><code>method: 'post'</code></li>
</ul>


<p><code>remote: true</code> turns this into an AJAX link. It&rsquo;s equivalent to writing a JavaScript event handler that process a an AJAX call when the link is clicked.</p>

<p><code>method: 'post'</code> turns the link in to a POST request as opposed to a GET request.</p>

<p>Both of these are necessary for the next step, the controller action.</p>

<p>When the user add a URL to the field and then clicks the &ldquo;Choose Post Image&rdquo; button it uses this rout:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">post</span> <span class="s1">&#39;/post_image&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;posts#post_image&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The link goes to the <code>post_image_path</code> , so a click on this link sends a POST request to the <code>post</code> controller&rsquo;s <code>post_image</code>  action , and because the link has the <code>remote: true</code> parameter, the format is JavaScript.</p>

<h3>4. what&rsquo;s happening in the <code>post_image</code> action in the <code>post</code> controller</h3>

<p>Here is the action in the controller:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">post_image</span>
</span><span class='line'>  <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">format</span><span class="o">.</span><span class="n">js</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@url</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here there are 3 things happening.
  - a new @post object is created. This is necessary because the post model has a method that fetches the images. So you need a post object to call that method
  - a @url variable is created from the URL field in the form. If you look at the &ldquo;Choose Post Image&rdquo; link you probably notice there is no URL parameter anywhere. I used JavaScript to dynamically add the url as a parameter to the link.
  - lastly, the action renders the default template <code>post_image.js.erb</code> . Since the request coming into the action is JavaScript formatted, the <code>respond_to</code> block send the request off to the <code>post_image.js.erb</code> template.</p>

<p> I should probably take a step back and show you the JavaScript that added the URL parameter to the link.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='Javascript'><span class='line'><span class="c1">// this makes the &quot;choose image button add the url parameter to the end of the link&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#choose_img_btn&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#post_url&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#choose_img_btn&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="nx">link</span> <span class="o">+</span> <span class="s2">&quot;?url=&quot;</span> <span class="o">+</span> <span class="nx">url</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#post_url&quot;</span><span class="p">).</span><span class="nx">change</span><span class="p">(</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">url</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#post_url&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">new_link</span> <span class="o">=</span> <span class="p">(</span><span class="nx">link</span> <span class="o">+</span> <span class="s2">&quot;?url=&quot;</span> <span class="o">+</span> <span class="nx">url</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#choose_img_btn&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="nx">new_link</span> <span class="p">);</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Basically what this does is append <code>?url=</code>  and whatever text is in the URL feild to the end of the link.</p>

<p>The link by default points to the <code>/post_image</code> path. So if you type <code>www.cnn.com</code> into the URL field, the link will automatically be turned into <code>/post_image?www.cnn.com</code></p>

<h3>5. inside the JavaScript template  <code>post_image.js.erb</code></h3>

<p>After the response goes through the controller action it ends up in the JavaScript template. Theis is where all of the cool AJAX stuff happens. Here is what the template looks like.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='Javascript'><span class='line'><span class="kd">var</span> <span class="nx">images_html</span> <span class="o">=</span> <span class="s1">&#39;&lt;ul class=&quot;choose_img_thumbs&quot;&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;%</span> <span class="k">if</span> <span class="err">@</span><span class="nx">post</span><span class="p">.</span><span class="nx">url_images</span><span class="p">(</span><span class="err">@</span><span class="nx">url</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;error&quot;</span>  <span class="o">%&gt;</span>
</span><span class='line'>  <span class="o">&lt;%</span> <span class="err">@</span><span class="nx">post</span><span class="p">.</span><span class="nx">url_images</span><span class="p">(</span><span class="err">@</span><span class="nx">url</span><span class="p">).</span><span class="nx">each</span> <span class="k">do</span> <span class="o">|</span><span class="nx">image</span><span class="o">|</span> <span class="o">%</span>
</span><span class='line'>    <span class="nx">images_html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">images_html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;%= image_tag image , id: &quot;url_image&quot; %&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">images_html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="o">&lt;%</span> <span class="nx">end</span> <span class="o">%&gt;</span>
</span><span class='line'>  <span class="nx">images_html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/ul&gt;&#39;</span>
</span><span class='line'><span class="o">&lt;%</span> <span class="k">else</span> <span class="o">%&gt;</span>
</span><span class='line'>  <span class="nx">images_html</span> <span class="o">+=</span> <span class="s1">&#39;You did not enter a valid URL. Please try again.&#39;</span>
</span><span class='line'><span class="o">&lt;%</span> <span class="nx">end</span> <span class="o">%&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#images_container&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">images_html</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#image_choices&quot;</span><span class="p">).</span><span class="nx">slideDown</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#image_choices img&quot;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#post_post_image&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">));</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#image_choices&quot;</span><span class="p">).</span><span class="nx">slideUp</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#post_image&quot;</span><span class="p">).</span><span class="nx">slideDown</span><span class="p">().</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;img src=&quot;&#39;</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot; /&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>To give you an idea of my though process I&rsquo;ll try to explain what this file does.</strong></p>

<ul>
<li>It creates an unordered list of images and then places them into a div with the ID of <code>images_container</code> .</li>
<li>Once the image list in inside the <code>images_container</code> , that div slides down. Keep in mind this is all happening on the create or edit post page.</li>
<li>After the <code>images_container</code> slides down, the user clicks on an image to choose it and assign it to the post.</li>
<li>once the chosen image has been clicked the <code>images_container</code> slides up and another hidden div <code>post_image</code> gets the chosen image inserted into it and slides down.</li>
</ul>


<p>The important part of this code is <code>@post.url_images(@url)</code> . Here is the <code>url_images</code> method in the Post model</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">url_images</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>  <span class="n">ext</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span><span class="s1">&#39;jpeg&#39;</span><span class="p">,</span><span class="s1">&#39;png&#39;</span><span class="p">,</span><span class="s1">&#39;gif&#39;</span><span class="p">,</span><span class="s1">&#39;bmp&#39;</span><span class="o">].</span><span class="n">include?</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
</span><span class='line'>    <span class="o">[</span><span class="n">url</span><span class="o">]</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>   <span class="k">begin</span>
</span><span class='line'>     <span class="n">page</span> <span class="o">=</span> <span class="no">MetaInspector</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>     <span class="n">page</span><span class="o">.</span><span class="n">images</span>
</span><span class='line'>   <span class="k">rescue</span>
</span><span class='line'>     <span class="s2">&quot;error&quot;</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are basically 3 important things going on here
  - the URL passes in is a link that goes directly to an image
  - the URL is a web page with images on it
  - there is a problem with the URL, in which case the string &ldquo;error&rdquo; is returned.</p>

<p>The first thing that happens is the URL is split apart on the dots (.) . If it&rsquo;s  an image URL like <code>www.mysite.com/myimage.jpg</code> the first condition in the if statement will execute and an array with the URL string will be returned.</p>

<p>If that&rsquo;s not the case the URL will be passed into MetaInspector and assigned to the <code>page</code> variable. MetaInspector scrapes information from a given URL and gives you several methods for accessing that data. In this case I just want the images. <code>page.images</code> returns an array of all the images retrieved by MetaInspector</p>

<p>If MetaInspector has a problem with the URL passed in it will throw an exception and the whole app will fail. To get around this I used a <code>begin and rescue block</code>. This way if there are any exception thrown by MetaInspector it will execute the rescue block and just return the string &ldquo;error&rdquo;.</p>

<p>So that&rsquo;s the first thing going on the JavaScript template. The first line is</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Javascript'><span class='line'><span class="o">&lt;%</span> <span class="k">if</span> <span class="err">@</span><span class="nx">post</span><span class="p">.</span><span class="nx">url_images</span><span class="p">(</span><span class="err">@</span><span class="nx">url</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;error&quot;</span>  <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>so as long as there is no error, this section will execute.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Javascript'><span class='line'><span class="o">&lt;%</span> <span class="err">@</span><span class="nx">post</span><span class="p">.</span><span class="nx">url_images</span><span class="p">(</span><span class="err">@</span><span class="nx">url</span><span class="p">).</span><span class="nx">each</span> <span class="k">do</span> <span class="o">|</span><span class="nx">image</span><span class="o">|</span> <span class="o">%</span>
</span><span class='line'>  <span class="nx">images_html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">images_html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;%= image_tag image , id: &quot;url_image&quot; %&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">images_html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/li&gt;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;%</span> <span class="nx">end</span> <span class="o">%&gt;</span>
</span><span class='line'><span class="nx">images_html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/ul&gt;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This creates the list of images inside an unordered list and assigns it to the <code>images_html</code> variable.</p>

<p>That list is put into the <code>#images_container</code> with this code</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#images_container&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">images_html</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then this part slides down the <code>#image_choices</code> and when an image is clicked 3 things happen</p>

<ul>
<li>this line <code>$("#post_post_image").val($(this).attr('src'));</code> adds the URL of the clicked image to a hidden form input  <code>"#post_post_image"</code></li>
<li>the <code>#image_choices</code> div slides up</li>
<li>the image is added to the <code>#post_image</code> div and it slides down</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#image_choices&quot;</span><span class="p">).</span><span class="nx">slideDown</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#image_choices img&quot;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#post_post_image&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">));</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#image_choices&quot;</span><span class="p">).</span><span class="nx">slideUp</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#post_image&quot;</span><span class="p">).</span><span class="nx">slideDown</span><span class="p">().</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;img src=&quot;&#39;</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot; /&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>6. finishing up the feature&rsquo;s workflow</h3>

<p>At this pont all that is left is the post has to be saved and the image URL will be added it the <code>post_image</code> column. This is because there is a hidden form input.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span>  <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:post_image</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I hope that made some sense and now you have some idea of how I did it. I took a combination of JavaScript, jQuery, AJAX, a scrapper gem, and standard rails MVC. I&rsquo;m sure there are things that can be improved on and tweaked to please feel free to leave feedback.</p>

<p>Thanks for reading and please send me any feedback to <a href="&#109;&#x61;&#x69;&#x6c;&#x74;&#x6f;&#58;&#100;&#115;&#116;&#101;&#105;&#110;&#45;&#x70;&#104;&#105;&#x6e;&#x73;&#x40;&#x68;&#x6f;&#116;&#x6d;&#97;&#105;&#x6c;&#x2e;&#99;&#111;&#x6d;&#46;">&#x64;&#115;&#116;&#101;&#x69;&#110;&#x2d;&#x70;&#104;&#x69;&#x6e;&#115;&#x40;&#104;&#111;&#x74;&#x6d;&#x61;&#x69;&#x6c;&#x2e;&#x63;&#111;&#x6d;&#x2e;</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Doug Steinberg</span></span>

      








  


<time datetime="2014-08-04T15:07:35+00:00" pubdate data-updated="true">Aug 4<sup>th</sup>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ajax/'>ajax</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/mvc/'>mvc</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>, <a class='category' href='/blog/categories/web-scrapers/'>web scrapers</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://doug7410.github.io/blog/2014/08/04/add-image-to-post-with-ajax-and-metainspector/" data-via="" data-counturl="http://doug7410.github.io/blog/2014/08/04/add-image-to-post-with-ajax-and-metainspector/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/07/16/rails-project-punch-clock-app/" title="Previous Post: Ruby on Rails project - Punch Clock App">&laquo; Ruby on Rails project - Punch Clock App</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/08/04/add-image-to-post-with-ajax-and-metainspector/">How I Added Images to My Postit App With AJAX and MetaInspector</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/16/rails-project-punch-clock-app/">Ruby on Rails Project - Punch Clock App</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/16/rapid-prototyping-with-ruby-on-rails-course-done/">Tealeaf - Rapid Prototyping With Ruby on Rails Cousre Done!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/25/say-hello-to-rails-and-all-the-magic/">Say Hello to Rails and All of It's Magic!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/17/putting-it-all-together-HTTP-MVC-Ajax-and-Sinatra/">Putting It All Together. Web Development With Ruby, HTTP, Ajax , MVC With Sinatra</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/doug7410">@doug7410</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'doug7410',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Doug Steinberg -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
